From 10c03f8621394f6597ce3ec793d96deda6cdc7db Mon Sep 17 00:00:00 2001
From: svoboda18 <ruspam18@gmail.com>
Date: Mon, 19 Nov 2018 16:57:21 +0000
Subject: [PATCH] Mediatek: Use MTK Serial Number.

---
 init/init.cpp | 34 +++++++++++++++++++++++++++++++++-
 1 file changed, 33 insertions(+), 1 deletion(-)

diff --git a/init/init.cpp b/init/init.cpp
index 8ea42ca..6afd984 100644
--- a/init/init.cpp
+++ b/init/init.cpp
@@ -770,6 +770,34 @@ static int console_init_action(int nargs, char **args)
     return 0;
 }
 
+#ifdef MTK_HARDWARE
+static int USE_MTK_SERIAL()
+{
+  int serialdir;
+  char serial[32];
+  size_t m;
+  serialdir = open("/sys/sys_info/serial_number", O_RDWR);
+              if (serialdir < 0) {
+                   NOTICE("fail to open: %s\n", "/sys/sys_info/serial_number");
+                   return 0;
+                    }
+  m = read(serialdir, serial, sizeof(char)*32);
+  serial[m-1] = '\0';
+  close(serialdir);
+
+  if (m <= 0) {
+	    NOTICE("could not get mtk serial number from  sys file\n");
+	    return 0;
+	}
+
+  NOTICE("serial number=%s\n",serial);
+  property_set("ro.boot.serialno", serial);
+
+  return 1;
+}
+#endif
+
+
 static void import_kernel_nv(char *name, bool for_emulator)
 {
     char *value = strchr(name, '=');
@@ -873,8 +901,12 @@ static void process_kernel_cmdline(void)
     import_kernel_cmdline(false, import_kernel_nv);
     if (qemu[0])
         import_kernel_cmdline(true, import_kernel_nv);
-}
 
+#ifdef MTK_HARDWARE
+    USE_MTK_SERIAL();
+#endif
+
+}
 static int queue_property_triggers_action(int nargs, char **args)
 {
     queue_all_property_triggers();
-- 
2.7.4

